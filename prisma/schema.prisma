generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AccountCategory {
  id          String        @id @default(uuid())
  name        String        @unique
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  AccountHead AccountHead[]
}

model Account {
  id            String         @id @default(uuid())
  name          String
  type          String
  code          String         @unique
  userId        String
  businessId    String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  User          User           @relation(fields: [userId], references: [id])
  Business      Business?      @relation(fields: [businessId], references: [id])
  creditEntries JournalEntry[] @relation("CreditAccount")
  debitEntries  JournalEntry[] @relation("DebitAccount")
  Reconciliations Reconciliation[]

  @@index([code])
  @@index([type])
  @@index([userId])
  @@index([businessId])
}

model JournalEntry {
  id               String             @id @default(uuid())
  date             DateTime
  description      String
  amount           Float
  debitAccountId   String
  creditAccountId  String
  userId           String
  businessId       String?
  status           String             @default("draft") // draft, posted, void
  referenceNumber  String?            @unique
  
  // GST Fields (India-specific)
  gstRate          Float?             // GST rate (5%, 12%, 18%, 28%)
  gstAmount        Float?             // GST amount
  gstin            String?            // GSTIN (15-digit)
  hsnCode          String?            // HSN/SAC code
  placeOfSupply    String?            // Place of supply (state)
  isInterState     Boolean            @default(false) // IGST vs CGST+SGST
  
  // TDS Fields (India-specific)
  tdsSection       String?            // TDS section (194C, 194J, etc.)
  tdsRate          Float?             // TDS rate
  tdsAmount        Float?             // TDS amount
  panNumber        String?            // PAN number for TDS
  
  // Additional India-specific fields
  isMsmeVendor     Boolean            @default(false) // MSME vendor flag
  invoiceNumber    String?            // Invoice number
  vendorName       String?            // Vendor/supplier name
  
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  creditAccount    Account            @relation("CreditAccount", fields: [creditAccountId], references: [id])
  debitAccount     Account            @relation("DebitAccount", fields: [debitAccountId], references: [id])
  User             User               @relation(fields: [userId], references: [id])
  Business         Business?          @relation(fields: [businessId], references: [id])
  JournalEntryItem JournalEntryItem[]

  @@index([creditAccountId])
  @@index([date])
  @@index([debitAccountId])
  @@index([userId])
  @@index([businessId])
  @@index([status])
  @@index([gstin])
  @@index([tdsSection])
  @@index([hsnCode])
}

model Transaction {
  id              String   @id @default(uuid())
  date            DateTime
  description     String
  amount          Float
  category        String
  transactionType String
  userId          String
  businessId      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  User            User     @relation(fields: [userId], references: [id])
  Business        Business? @relation(fields: [businessId], references: [id])
  StatementLines  StatementLine[]

  @@index([category])
  @@index([date])
  @@index([transactionType])
  @@index([userId])
  @@index([businessId])
}

model Business {
  id                String         @id @default(uuid())
  name              String
  registrationNumber String?        @unique
  type              String         // sole_proprietorship, partnership, corporation, llc
  description       String?
  incorporationDate DateTime?
  fiscalYearStart   DateTime?
  fiscalYearEnd     DateTime?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  taxId             String?
  phone             String?
  email             String?
  website           String?
  ownerId           String
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  Owner             User           @relation("BusinessOwner", fields: [ownerId], references: [id])
  Users             UserBusiness[]
  Accounts          Account[]
  JournalEntries    JournalEntry[]
  Transactions      Transaction[]
  BankStatements    BankStatement[]
  Reconciliations   Reconciliation[]

  @@index([ownerId])
  @@index([type])
}

model UserBusiness {
  id         String   @id @default(uuid())
  userId     String
  businessId String
  role       String   @default("VIEWER") // ADMIN, BUSINESS_OWNER, ACCOUNTANT, VIEWER
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Business  Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@index([role])
}

model BankStatement {
  id          String   @id @default(uuid())
  fileName    String
  filePath    String
  bankType    String   // hdfc, icici, sbi, axis, kotak, yes, other
  uploadDate  DateTime @default(now())
  processDate DateTime?
  status      String   @default("uploaded") // uploaded, processing, completed, failed
  userId      String
  businessId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  User        User     @relation(fields: [userId], references: [id])
  Business    Business? @relation(fields: [businessId], references: [id])

  @@index([userId])
  @@index([businessId])
  @@index([bankType])
  @@index([status])
}

model AccountHead {
  id                String             @id
  code              String             @unique
  name              String
  description       String?
  categoryId        String
  isCustom          Boolean            @default(false)
  parentId          String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  AccountCategory   AccountCategory    @relation(fields: [categoryId], references: [id])
  AccountHead       AccountHead?       @relation("AccountHeadToAccountHead", fields: [parentId], references: [id])
  other_AccountHead AccountHead[]      @relation("AccountHeadToAccountHead")
  JournalEntryItem  JournalEntryItem[]
  LedgerEntry       LedgerEntry[]

  @@index([categoryId])
  @@index([parentId])
}

model CompanySettings {
  id              String   @id
  companyName     String
  address         String?
  taxNumber       String?
  phone           String?
  email           String?
  fiscalYearStart DateTime
  baseCurrency    String   @default("INR")
  createdAt       DateTime @default(now())
  updatedAt       DateTime
}

model FinancialYear {
  id        String   @id
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([startDate, endDate])
  @@index([isActive])
}

model JournalEntryItem {
  id             String       @id
  journalEntryId String
  accountHeadId  String
  description    String?
  debitAmount    Decimal      @default(0)
  creditAmount   Decimal      @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  AccountHead    AccountHead  @relation(fields: [accountHeadId], references: [id])
  JournalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])

  @@index([accountHeadId])
  @@index([journalEntryId])
}

model LedgerEntry {
  id            String      @id
  accountHeadId String
  date          DateTime
  description   String
  debitAmount   Decimal     @default(0)
  creditAmount  Decimal     @default(0)
  balance       Decimal
  reference     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  AccountHead   AccountHead @relation(fields: [accountHeadId], references: [id])

  @@index([accountHeadId])
  @@index([date])
}

model User {
  id               String         @id
  name             String
  email            String         @unique
  password         String
  role             String         @default("VIEWER")
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  
  // Relations
  Account          Account[]
  JournalEntry     JournalEntry[]
  Transaction      Transaction[]
  BankStatements   BankStatement[]
  OwnedBusinesses  Business[]     @relation("BusinessOwner")
  UserBusinesses   UserBusiness[]
  Reconciliations  Reconciliation[]
}

// Reconciliation Models
model Reconciliation {
  id            String   @id @default(uuid())
  accountId     String
  statementDate DateTime
  closingBalance Float
  isLocked      Boolean  @default(false)
  userId        String
  businessId    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  Account       Account  @relation(fields: [accountId], references: [id])
  User          User     @relation(fields: [userId], references: [id])
  Business      Business? @relation(fields: [businessId], references: [id])
  StatementLines StatementLine[]

  @@index([accountId])
  @@index([userId])
  @@index([businessId])
  @@index([statementDate])
}

model StatementLine {
  id               String   @id @default(uuid())
  reconciliationId String
  transactionId    String?
  date             DateTime
  description      String
  amount           Float
  status           String   @default("UNMATCHED") // MATCHED, UNMATCHED, ADJUSTED
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  Reconciliation   Reconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  Transaction      Transaction?   @relation(fields: [transactionId], references: [id])

  @@index([reconciliationId])
  @@index([transactionId])
  @@index([date])
  @@index([status])
}
